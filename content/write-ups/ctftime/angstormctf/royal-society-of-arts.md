---
author: "Asad Ullah"
title: "Royal Society of Arts - ångstromCTF"
description: 
summary: Write-up on cryptography challenge Royal Society of Arts.
date: 2023-04-27T01:00:24+05:00
Section: write-ups
categories:
- writeup
- ctftime.org
tags:
- angstormctf
- crypto
- rsa
- factordb

draft: true

---

{{< 
ctftime 
name="Royal Society of Arts" 
difficulty="Medium"  
points="70"
category="Cryptography"
>}}

&nbsp;

&nbsp;

## Description

RSA strikes strikes strikes strikes again again again again!

[rsa.py](https://files.actf.co/b41e4a18e2caac4975cd7b50a6527ba2b9f35056056bd89ba9bcd5c54f0251ab/rsa.py) [output](https://files.actf.co/e326e28dd98d3b38e06d63f96d3d7945bb294d605c2dcb1cc8ddc442f92c0a0b/out.txt)


## Approach

**rsa.py**

```python
from Crypto.Util.number import getStrongPrime, bytes_to_long
f = open("flag.txt").read()
m = bytes_to_long(f.encode())
p = getStrongPrime(512)
q = getStrongPrime(512)
n = p*q
e = 65537
c = pow(m,e,n)
print("n =",n)
print("e =",e)
print("c =",c)
print("(p-2)*(q-1) =", (p-2)*(q-1))
print("(p-1)*(q-2) =", (p-1)*(q-2))
```

**output**

```python
n = 125152237161980107859596658891851084232065907177682165993300073587653109353529564397637482758441209445085460664497151026134819384539887509146955251284230158509195522123739130077725744091649212709410268449632822394998403777113982287135909401792915941770405800840172214125677106752311001755849804716850482011237
e = 65537
c = 40544832072726879770661606103417010618988078158535064967318135325645800905492733782556836821807067038917156891878646364780739241157067824416245546374568847937204678288252116089080688173934638564031950544806463980467254757125934359394683198190255474629179266277601987023393543376811412693043039558487983367289
(p-2)*(q-1) = 125152237161980107859596658891851084232065907177682165993300073587653109353529564397637482758441209445085460664497151026134819384539887509146955251284230125943565148141498300205893475242956903188936949934637477735897301870046234768439825644866543391610507164360506843171701976641285249754264159339017466738250
(p-1)*(q-2) = 125152237161980107859596658891851084232065907177682165993300073587653109353529564397637482758441209445085460664497151026134819384539887509146955251284230123577760657520479879758538312798938234126141096433998438004751495264208294710150161381066757910797946636886901614307738041629014360829994204066455759806614
```

&nbsp;

{{< toggle title="finding $p$ and $q$" >}}
  
  &nbsp;

We know that:  

$a = (p-1)(q-2)$  
$b = (p-2)(q-1)$  
$n = p*q$

For eq a:

$a = (p-1)*(q-2)$  
$a = pq - 2p - q + 2$   
$pq = a + 2p + q - 2$  


For eq b:

$b = (p-2)*(q-1)$  
$b = pq - p - 2q + 2$  
$pq = b + p + 2q - 2$  



Now, we have two equations for pq.  

$pq = a + 2p + q - 2$  
$pq = b + p + 2q - 2$  

Setting these two equations equal to each other, we get:

$b + p + 2q - 2 = a + 2p + q - 2$

Simplifying, we get:

$p + q = a + b$

We can use this equation to solve for one of the variables in terms of the others. Let's solve for q:

$q = a + b - p$

Substituting this expression for q into the equation for n, we get:

$n = pq = p(a + b - p)$

Expanding and rearranging, we get a quadratic equation in p:

$p^2 - (a + b)p + n = 0$

Using the quadratic formula, we can solve for p:

$p = \frac{a+b \pm \sqrt{(a+b)^2 - 4n}}{2}$


Once we have found p, we can use the equation we derived earlier to solve for q:

$q = n/p$

**So the final solution for p and q is:**

$p = \frac{a+b \pm \sqrt{(a+b)^2 - 4n}}{2}$    
$q = n/p$

{{< /toggle >}}

&nbsp;

we can find p and q from above equations using python.

```python
from gmpy2 import isqrt

def find_p_q(a, b, n):
     
    p = (a - b + isqrt((a - b)**2 + 4*n)) // 2
    q = n // p
    
    return int(p), int(q)


a = 125152237161980107859596658891851084232065907177682165993300073587653109353529564397637482758441209445085460664497151026134819384539887509146955251284230123577760657520479879758538312798938234126141096433998438004751495264208294710150161381066757910797946636886901614307738041629014360829994204066455759806614
b = 125152237161980107859596658891851084232065907177682165993300073587653109353529564397637482758441209445085460664497151026134819384539887509146955251284230125943565148141498300205893475242956903188936949934637477735897301870046234768439825644866543391610507164360506843171701976641285249754264159339017466738250
n = 125152237161980107859596658891851084232065907177682165993300073587653109353529564397637482758441209445085460664497151026134819384539887509146955251284230158509195522123739130077725744091649212709410268449632822394998403777113982287135909401792915941770405800840172214125677106752311001755849804716850482011237

p, q = find_p_q(a, b, n)
print("p =", p)
print("q =", q)

```

```python
p = 10066608627787074136474825702134891213485892488338118768309318431767076602486802139831042195689782446036335353380696670398366251621025771896701757102780451
q = 12432413118408092556922180864578909882548688341838757808040464238372914542545091804094841981170595006563808958609560634333378522509950041851974318809712087
```

&nbsp;

{{< toggle title="decrypting Rsa" >}}
  
  &nbsp;

1. Compute \\(\phi(n) = (p-1)(q-1)\\), where \\(p\\) and \\(q\\) are the prime factors of \\(n\\).
2. Calculate the modular multiplicative inverse of \\(e\\) modulo \\(\phi(n)\\), denoted as \\(d\\), such that \\((d \cdot e) \bmod \phi(n) = 1\\). This can be done using the extended Euclidean algorithm. In python we can use `inverse` function from `Crypto.Util.number`
3. To decrypt the ciphertext, compute \\(m = c^d \bmod n\\). In python `pow(c, d, n)`.  
The plaintext message, denoted as \\(m\\), can then be obtained by converting the resulting integer value to its corresponding character representation.

{{< /toggle >}}

```python
from Crypto.Util.number import long_to_bytes, inverse

p = 10066608627787074136474825702134891213485892488338118768309318431767076602486802139831042195689782446036335353380696670398366251621025771896701757102780451
q = 12432413118408092556922180864578909882548688341838757808040464238372914542545091804094841981170595006563808958609560634333378522509950041851974318809712087

n = p * q
e = 65537
phi = (p - 1) * (q - 1)
d = inverse(e, phi)

c = 40544832072726879770661606103417010618988078158535064967318135325645800905492733782556836821807067038917156891878646364780739241157067824416245546374568847937204678288252116089080688173934638564031950544806463980467254757125934359394683198190255474629179266277601987023393543376811412693043039558487983367289
m = pow(c, d, n)

plaintext = long_to_bytes(m)
print(plaintext.decode())
```

&nbsp;

---

**Flag:  `actf{tw0_equ4ti0ns_in_tw0_unkn0wns_d62507431b7e7087}`**

---

&nbsp;

&nbsp;
